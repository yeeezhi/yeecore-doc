###########################
#
# YeeCore 表达式
# https://yeecore.goodmc.cn/
#
###########################
# 
# 该配置暂时不支持强化石，保护符，直升，转移，若需要使用该配置特性请自行在“默认强化.yml”中使用物品操作器
#
# 允许强化的装备
match:
  - "match.name('测试武器')"
  - "match.name('帝国立法者圣剑')"
# 变量库
entry:
  # int() 用于将获取到的字符串转数值类型,若获取的NBT为空(不存在)时转数值，结果为0
  "当前等级": "${int(获取NBT('强化等级'))}"
  "升级等级": "${{当前等级}+1}"
  "掉级等级": "${{当前等级}-1}"
  "初始物品名": "${获取NBT('初始值.物品名')}"
  "初始攻击力": "${获取NBT('初始值.攻击力')}"
  "初始暴击几率": "${获取NBT('初始值.暴击几率')}"
  "初始暴击伤害": "${获取NBT('初始值.暴击伤害')}"
  # 大于1级概率75%，大于5级概率70%，大于10级概率50%，大于15级概率25%
  "成功率": "${{升级等级}>1 ? 0.75 : {升级等级}>5 ? 0.7 : {升级等级}>10 ? 0.5 : {升级等级}>15 ? 0.25 : 1}"
  # 大于1级概率75%，大于5级概率70%，大于10级概率50%，大于15级概率25%
  "掉级几率": "${{升级等级}>1 ? 0.75 : {升级等级}>5 ? 0.7 : {升级等级}>10 ? 0.5 : {升级等级}>15 ? 0.25 : 1}"
  # 结果为true或false
  "强化结果": "${random()<{成功率}}"
  # 结果为true或false
  "触发掉级": "${random()<{掉级几率}}"
# 强化配方
intensify:
  '首次强化':
    match:
      - "{当前等级}==0"
    # 物品操作器,支持任意表达式
    operate:
      # 首次强化在NBT记录初始值
      - "设置NBT('强化等级','1')"
      - "设置NBT('初始值.物品名',获取物品名())"
      - "设置NBT('初始值.攻击力',数值获取('攻击力'))"
      - "设置NBT('初始值.暴击几率',数值获取('暴击几率'))"
      - "设置NBT('初始值.暴击伤害',数值获取('暴击伤害'))"
      # 操作物品信息
      - "设置物品名(获取物品名()+' §f(+1)')"
      - "数值修改('攻击力','n*1.1')"
      - "数值修改('暴击几率','n*1.1')"
      - "数值修改('暴击伤害','n*1.1')"
    # 强化材料
    material:
      - "mm 测试材料 10"
  '强化升级':
    match:
      - "{当前等级}>0"
    # 复杂需求场景可使用rules
    rules:
      # 强化成功
      - condition:
          - "{强化结果}"
        operate:
          # 使用NBT中的初始值修改物品
          - "设置NBT('强化等级','{升级等级}')"
          - "设置物品名('{初始物品名} §f(+{升级等级})')"
          - "数值修改('攻击力','{初始攻击力}+{初始攻击力}*(0.1+({升级等级}*0.1))')"
          - "数值修改('暴击几率','{初始暴击几率}+{初始暴击几率}*(0.1+({升级等级}*0.1))')"
          - "数值修改('暴击伤害','{初始暴击伤害}+{初始暴击伤害}*(0.1+({升级等级}*0.1))')"
        action:
          - "msg('{prefix}§f强化成功')"
          - "sound('BLOCK_ANVIL_LAND')"
      # 强化失败
      - condition:
          # 强化失败和未触发降级
          - "!{强化结果} && !{触发掉级}"
        action:
          - "msg('{prefix}§c强化失败')"
          - "sound('ENTITY_ITEM_BREAK')"
      # 触发掉级
      - condition:
          # 强化结果false和触发掉级true时触发掉级
          - "!{强化结果} && {触发掉级}"
        operate:
          # 使用NBT中的初始值修改物品
          - "设置NBT('强化等级','{掉级等级}')"
          - "设置物品名('{初始物品名} §f(+{掉级等级})')"
          - "数值修改('攻击力','{初始攻击力}+{初始攻击力}*(0.1+({掉级等级}*0.1))')"
          - "数值修改('暴击几率','{初始暴击几率}+{初始暴击几率}*(0.1+({掉级等级}*0.1))')"
          - "数值修改('暴击伤害','{初始暴击伤害}+{初始暴击伤害}*(0.1+({掉级等级}*0.1))')"
        action:
          - "msg('{prefix}§7强化失败,已降级至 §f{掉级等级}')"
          - "sound('ENTITY_ITEM_BREAK')"
    operate:
    # 限制强化等级上限
    condition:
      - "{当前等级}<20 else '{prefix}§7已达到强化等级上限'"
    material:
      - "mm 测试材料 10"
      # 原理：判断升级等级是否满足，不满足则返回'',将不识别材料
      # 升级等级达到5时额外增加材料
      - "${{升级等级}>5 ? 'mm 测试材料 5' : ''}"
      # 升级等级达到10时额外增加材料(与上面叠加)
      - "${{升级等级}>10 ? 'mm 测试材料 5' : ''}"